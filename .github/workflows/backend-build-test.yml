name: Build & Test - Backend (Maven)

on:
  push:
    branches: [ main, develop, fix/*, feature/* ]
    paths:
      - 'backend/**'
      - 'pom.xml'
      - '.github/workflows/backend-build-test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'pom.xml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java-version: ['17']
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v3
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'adopt'
        cache: maven
    
    - name: Display Java version
      run: java -version
    
    - name: Build with Maven
      run: |
        cd backend
        mvn clean package -DskipTests -X
      env:
        MAVEN_OPTS: "-Xmx1024m"
    
    - name: Run Unit Tests
      run: |
        cd backend
        mvn test -Dtest="**/*Test" --no-transfer-progress
    
    - name: Run Integration Tests
      run: |
        cd backend
        mvn verify -DskipUnitTests --no-transfer-progress
    
    - name: Generate Coverage Report
      run: |
        cd backend
        mvn jacoco:report
    
    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./backend/target/site/jacoco/jacoco.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: maven-test-reports
        path: backend/target/surefire-reports/
    
    - name: Archive coverage reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: coverage-reports
        path: backend/target/site/jacoco/

  sonarqube:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'adopt'
        cache: maven
    
    - name: SonarQube Scan
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        cd backend
        mvn clean verify sonar:sonar \
          -Dsonar.projectKey=ExpenseNoteApp \
          -Dsonar.sources=src/main \
          -Dsonar.exclusions='src/test/**'
      if: env.SONAR_TOKEN != ''
